## 自叙
一个普通的魔兽玩家而已。没什么耀人的优点，却还一身毛病。容易玻璃心，没有管理能力，游戏打得还差劲。

## 前言
《魔兽世界》是一个活跃了超过15年的网络游戏，这些年来不断的推陈出新，在游戏内容上给我们带来各种各样的惊喜。在UI界面、游戏交互、视觉效果上也都提供了更多的支持。这些自然也激发了玩家对掌控游戏内容和自定义游戏功能上的热情和兴趣。
为了满足玩家们和开发人员的不同需求，魔兽世界的结构和API一直在不断地慢慢地变化，以达到某些效果或某个功能的使用目的。因此，任何引用API的文献教程或参考网站都会随着时间的推移而慢慢过时（包括现在的9.1.0，也会在将来因补丁和更新而导致某个功能版本过时）。
有时候你会发现过时的东西可能都还没学会，而新的东西就如海啸般向你涌来，甚至光去找最新的资料就已经花了你大量的时间和精力。或许得到这样的消息会让你感到些许失落，甚至没有想继续学习下去的动力。
这样挫败感令人让人容易放弃。但这是有办法来降低你的挫败感的，比如在这个大版本刚更新完，整个版本慢慢趋于稳定的时候来学习它。仔细一想，你有整整一个大版本来学习它。还有一种方法，就是有人来整理和列出最新的暴雪API引用网站和材料，因为大多是国外网站，不花点力气还真是不好找。最后也最重要的是，你应该相信一点，只要你愿意花时间，你学习的速度远远快于那些程序员的更新速度。就像我写到这足足花了我20分钟，而你阅读可能只花了1分钟。
还有一点你必须知道，魔兽的高度定制化UI归功于这15年来积累的庞大的结构和API，但你并不需要全部了解它们，你只需要能在短时间内找到并使用它们就已经足够优秀。而如何完成一个优秀的插件取决于你的编程经验和寻找可用信息的技巧。但即使你没经验也可以通过学习别人的插件来构建你自己的插件，没技巧也可以只使用简单`if-elseif-else-end`来写一个具有完整功能插件。


有四本书可以用来学习：分别是
《World of Warcraft Programming: A Guide and Reference for Creating WoW Addons》
《World of Warcraft Programming: A Guide and Reference for Creating WoW Addons (second edition)》
《Beginning Lua with World of Warcraft Addons》
《Hacking World of Warcraft》
这几本书都是在巫妖王时期，有的在巫妖王早期，有的在末期（正是我们当时的巫妖王早期）。前面两本书的销售网站：[World of Warcraft Programming](https://wowprogramming.com/)


插件主要由三种文件构成，用于描述的toc文件，用于实体定义的xml文件和脚本执行主体的lua文件。
toc文件主要用来描述插件本身的属性，如插件版本，作者，修改日期以及依赖。
xml文件用来指定要显示界面样式和风格。xml可以用来定义插件在游戏中的界面及处理的逻辑，但现在慢慢由lua的函数库取代了，xml的作用没那么大了，可以用来做配置文件。
lua文件是用来处理界面时间的脚本。也就是某个功能的具体实现。修改插件的功能就是修改它的lua脚本文件。
《魔兽世界》的游戏结构是基于事件处理编程的，即当某一事件发生以后，所有需要捕获该事件的代码都会被触发（响应）。


### toc文件
toc文件承载着插件的一些基本信息。它为《魔兽世界》客户端调用你插件的脚本提供类似于“索引”或“说明”的相关内容。一个常见的toc文件通常会包含以下一部分甚至全部的内容：
`##`是客户端调用的标签。若你需要在toc文件中使用备注或者注释，可以使用单个`#`进行说明。

`Interface` - 标记该插件用于wow的哪个游戏版本，如果标记值低于当前游戏版本将被提示该插件是“过期的”。除非用户选择加载过期插件。所以，大版本更新时，最好修改这个标记值来符合新的游戏版本。可以在进入游戏后使用宏来获得当前游戏的版本号：`/run print((select(4, GetBuildInfo())))`
`Title` - 插件的名称，不需要和插件名一致，会被显示在选择人物界面的插件列表中。如果需要实现不同语种的客户端显示不同的文字的话(本地化机能)，可以修改标签名，在标签名后加上一个"-"，再跟上客户端的语种名就可以了。例如国服的实际标签名：`Title-zhCN`。如果客户端的语种对应的标签不存在，那么就使用默认的Title标签的值。
`Notes` - 在插件列表中，鼠标移到插件名称上时显示的提示信息。同样，可以用类似-zhCN这样的后缀来做本地化声明。
`RequiredDeps`, `Dependencies`, `或者任意以 "Dep" 开始的字符串` - 一些以逗号分割的其他插件的名字，表示本插件必须在这些插件都存在，且都已经被加载的情况下，才能被加载，也就是插件依赖。
`OptionalDeps` - 一些以逗号分割的其他插件的名字，表示如果这些插件存在，那么这些插件需要在本插件加载前，被加载，可选依赖。
`LoadOnDemand` - 如果这个值被设置为1，那么这个插件不会在游戏开始时就加载，而是由其他插件在需要时，另行加载，wow自带的一些插件都是如此设置的。
`LoadWith` - 一些以逗号分割的其他插件的名字， 如果本插件的LoadOnDemand为1，那么，当这些插件在游戏开始被加载时，也加载本插件。
`LoadManagers` - 一些以逗号分割的其他插件的名字， 如果这些插件都不存在，那么客户端会自动加载本插件，如果这些插件中的一个存在，那么，本插件将按照LoadOnDemand设置为1的情况处理。
`SavedVariables` - 一些以逗号分割的变量名称，这些变量一般是保存在游戏中的Lua全局环境中的表，这些变量的值在退出游戏时将被保存到硬盘上，在下一次游戏开始再被加载进入游戏，可以用来保存用户的配置信息等。这些变量的值对同一账户在同一服务器的所有角色都是通用的。可以用逗号分隔开，保存多个。
`SavedVariablesPerCharacter` - 类似SavedVariables，不过，每个角色都有各自不同的变量值，也就是说，SavedVariables适合保存通用配置，SavedVariablesPerCharacter适合保存个人配置。可用用逗号分隔开，保存多个。
`DefaultState` - 本插件安装后默认是否开启，如果设置成 "Disabled"，那么只有在插件列表中勾选本插件后，才会被加载。默认值 "Enabled"
`Author` - 作者名字
`Version` - 插件自身的版本号

你也可以自己定义标签，让其他查看toc文件的人员简单了解你的插件信息。例如定义一个展示你邮箱的标签：`## Mile`。

另外，任何一个以X开头并且包含了带有某些具体值的标签的域都被认为是插件的元数据，它们都可以从游戏内部进行访问。例如## X-Website。
每一个X-Label都会被游戏客户端本地化。因此你可以包含下面的全部文本，但是只有正确的版本对于GetAddOnMetadata()API函数才是可用的。


```
# 插件使用的游戏版本，《魔兽世界》客户端用这一项判断插件是否过期。
## Interface: 11302

# 插件的名字，这个插件叫做oHWell。
## Title: oHWell

# 插件的说明与备注，主要用来说明插件的功能
## Notes: Dismount, cancel form, stand up

# 插件自身的版本。
## Version: C1.2

# 插件的作者。
## Author: EK

# 该插件安装后默认是否开启，默认值为"Enabled"。
## DefaultState: Enabled

# 插件用于保存游戏数据的文件名。
## SavedVariables: TestAddonSave
```

------------------------
------------------------

无论toc、xml、lua文件，都需要保存为UTF-8的编码格式。

早在上个时期，在interface下面有多个文件夹
我不讲Lua基础，这部分既乏味，又对你没有任何帮助。

在8.1之后暴雪更改了文件夹结构，把测试服（ptr服）、正式服、和怀旧服分开了。


下载插件是用粘贴似乎是用粘贴覆盖的方式。

插件并不一定需要xml文件。例如有个插件idTip。它就只有三个文件，其中一个还是自述文件。

开发插件最困难的不在于有没有点子，而在于你如何找到合适的东西去构建你的点子。
这其中最困难的是使用魔兽的api

而最好的方法是去看看别人怎么使用的。
最好找一些没使用库的插件。

又个问题是，你如果用插件修改了某个东西，它可能无法再变回来了。（除非你重新装游戏）。例如你修改了某些地方的提示信息。

先找一些不需要参数的方法看。再找一些只有一个参数的看。

魔兽中有一个很重要的hooksecurefunc()方法。会再要hook的函数执行即将结束时该传入参数传递到你提供的functon中。
更简单的说法是绑定一个新函数到旧函数之后运行。参数与旧函数相同，但返回值会被忽略。
一般用来增强原函数，或者重写原函数的部分功能。比如自带任务列表文字修改，染色什么的都是属于在暴雪UI做完操作后，再修改到我们想要的样子。
http://wowwiki.wikia.com/wiki/API_hooksecurefunc

魔兽的框架是具有ID的，例如windows的句柄。


插件SimulationCraft虽然用到了很多库，但还是一个不错的可以用来学习的插件，因为它足够简单。


	
Extended Vendor UI插件和already knows插件有冲突。
但already knows本身不会显示背包中已经学习的图纸
Extended Vendor UI已经有一个大版本没有更新了


创建框体需要材质（texture）
框架不能删除，尽量重用框架。

用CreateFrame定义框体Frame
https://wowpedia.fandom.com/wiki/API_CreateFrame

往定义的框体Frame添加材质，具体的一些Frame在这里。
https://wowpedia.fandom.com/wiki/UIOBJECT_Frame

大体上有两种方法可以创建框体，一个是XML一个是Lua。


魔兽的插件是按顺序从上到下载入的。local只会在自己的插件中属于自己的作用域。而全局变量所有的插件都可以调用和修改。


为了安全和限制过分的自由，在《魔兽世界》中，插件被分为安全插件和非安全插件。《魔兽世界》自带的插件都是属于安全插件。如果玩家插件Hook了安全插件的函数，那么就会因为安全插件的污染导致出错。所以，原则上，我们是不能针对WOW自带的插件使用Hook技术的。但我们可以针对第三方的插件使用。当然也可以对lua高级语言自身使用。



有两种常用的定位方式，一种是绝对定位，另一种是相对定位（偏移量）。
绝对定位用的是指定某个点与某个点的距离，如框体左上角的点和魔兽屏幕窗体左上角的点的距离。
相对定位是两个框体，的某个点对应，再移动偏移量。





WTF文件，有一个文件和两个文件夹，其中客户端范围内的大部分变量可以在Config.wtf中找到。而魔兽账户范围内的变量可以在Account\账户#子账号\ config-cache.wtf中找到。特定与字符的变量可以在\World of Warcraft\_retail_\WTF\Account\<AccountName>\<Server>\<Character>\config-cache.wtf下找到。



wow每次只能读取1024字节，富裕出的部分将被忽略且不报错。


编辑toc文件必须重启游戏，编辑lua和xml可以不用。xml中可以调用lua文件。lua文件嵌入式脚本语言。在wow中实现.xml调用的函数。
绑定文件：
内容文件：

身上各个部位编号：
1：头
2：颈
3：肩
4：衬衣
5：胸
6：腰带
7：腿
8：脚
9：手腕
10：手套
11：手指1
12：手指2
13：饰品1
14：饰品2
15：背
16：主手
17：副手
18：远程武器

动作条编号：
主动作条1为 1--12
主动作条2为13--24
主动作条3（右1）为25--36
主动作条4（右2）为37--48
主动作条5（右下）为49--60
主动作条6（左下）为61--72

背包及包裹格子编号：
背包从右到左的编号分别是：4、3、2、1、0~
包裹格子的编号是从左至右排列，一个包的第一行分别是：1、2、3、4~
然后是包裹第2行：5、6、7、8~下面几行依次类推。



## 锚点
参考：[[欢迎来到小N老师的Lua新手讲堂] 第一讲 锚点与位置 (基本完工)](https://bbs.nga.cn/read.php?tid=4555096)

我们可用使用绝对位置来确定每个框体或部件的位置，但当我们移动这个框体所有的东西都需要重新计算调整绝对位置。如果你使用过wa插件来调整图标的位置你就会比较熟悉这块内容。
而当我们使用相对位置的话就简单很多。我们只需要移动主要的部件，其他部件就会计算相对位置而跟着移动。锚点就是用来确定两个图形之间的相对位置的。
两个圆之间的距离，我们通常说的是两个圆心之间的线段距离，当然有时候也会指两个圆周之间最短的线段距离。而这条线段的两端就是我们现在要说的锚点。
在游戏中我们遇到的通常是矩形框体。任何不规则的图形也可以使用一个合适大小的矩形框体将其包在里面。


## mixin
在XML中有种标签叫做mixin，这个标签在lua中会被替换成框体的名字。
在StackSplitFrame.xml中，StackSplitFrame框体有个mixin标签，其值为StackSplitMixin。
但在后面的代码调用中使用了StackSplitFrame作为主体。


## 疑问？
是暴雪的插件先加载还是，无论是暴雪的还是自己的，都按照名字加载？


## 事件
https://wowpedia.fandom.com/wiki/API_Frame_RegisterEvent
事件是《魔兽世界》客户端产生的，而框体本身只是注册监听。某个框体监听某个事件，从而让该框体对该事件做出反应。这是一种类似于应激性的特性。
一个框体可以使用:RegisterEvent()来注册事件监听。一个框体只能有一个<OnEvent>脚本，但可以注册任意多的监听
在XML中的<script事件>表示的是，你对当前窗体执行某个动作后发生的事情。例如对某个窗体的单击
但注册事件呢？注册事件
某个角色或单位做了某件事，或固定的例如游戏刷新，加载，会发出游戏事件。而注册游戏事件是表示让这个事件发送给你当前的窗体。
游戏事件是由游戏客户端把信息发送到用户界面
当某个角色受到伤害后生命值发生了改变，会触发UNIT_HEALTH事件。而一个窗口注册事件表示，它会对这个事件做出反应。因为不像单击鼠标，我们是主动触发的，UNIT_HEALTH是游戏客户端触发的。一些框体以外的事件需要我们主动注册。


## 钩子
钩子函数分为前钩和后钩
前钩可以改变传入的参数，在函数执行前改变参数
后钩可以在原始函数返回之后起作用
钩子函数会取决插件加载的顺序。而插件加载的顺序是完全被游戏引擎控制的。